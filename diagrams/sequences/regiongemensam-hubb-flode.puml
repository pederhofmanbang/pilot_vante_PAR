@startuml
' =========================================================
' Regiongemensamt flöde (pilot + målbild) – Sekvensdiagram
' Deltagare: Region (vänster), Hubb (mitten), SPE (separat mitt), Externa användare (höger)
' =========================================================

title Regiongemensam hubb – flöde, federering och distribution (detaljnivå)

autonumber
hide footbox

skinparam shadowing false
skinparam backgroundColor #FFFFFF
skinparam sequence {
  ArrowColor #1F2937
  LifeLineBorderColor #9CA3AF
  LifeLineBackgroundColor #FFFFFF
  ParticipantBorderColor #111827
  ParticipantBackgroundColor #F9FAFB
  ParticipantFontColor #111827
  BoxBorderColor #6B7280
  BoxBackgroundColor #F3F4F6
  GroupBackgroundColor #F9FAFB
  GroupBorderColor #9CA3AF
  NoteBackgroundColor #FFF7ED
  NoteBorderColor #F59E0B
}

' ---------------------------------------------------------
' Layout / swimlane-känsla
' ---------------------------------------------------------
box "Region" #ECFDF5
participant Region as "Region\n(Producent + mottagare)"
end box

box "Hubb (värd: t.ex. VGR)" #EFF6FF
participant Hubb as "Hubb\n(Standard + benchmark + distribution)"
end box

box "SPE (kan drivas av region, myndighet eller annan aktör)" #F5F3FF
participant SPE as "SPE\n(Federerad beräkning vid behov)"
end box

box "Externa användare" #FFFBEB
participant Externa as "Externa användare\n(SoS, forskning, m.fl.)"
end box

' =========================================================
' 0) Översikt/legend (synlig info istället för hover)
' =========================================================
note right of Hubb
**Hubbens standardpaket (P1–P7), publiceras & versionshålls centralt**
P1. Gemensamma variabellistor (vad som behövs, definitioner)
P2. Gemensamma definitioner/struktur ("samma sak betyder samma sak")
P3. Gemensamt räknesätt för väntetider
P4. Gemensamma kvalitetskontroller (stoppar/varnar)
P5. Stöd för att koppla rätt (inkl. intelligent assistans)
P6. Mallar för leveranser till mottagare (t.ex. SoS väntetider & PAR)
P7. Spårbarhet (version, förändringar, "vad kördes när")
end note

note right of SPE
**Vad SPE är (i det här upplägget)**
- Kör frågor "nära datat" (i regionerna)
- Hämtar inte hem individnivå i bulk
- Samlar bara sammanställda delresultat
- Används bara när centrala beräkningar kräver det
end note

legend left
**Exempel på federerade frågor (Q1–Q3)**
Q1: Jämför väntetider per område & månad (median/percentiler)
Q2: Datakvalitet – andel saknade/ogiltiga fält senaste perioden
Q3: Andel som passerar gränsvärde (t.ex. > X dagar) per vecka
endlegend

' =========================================================
' 0b) Fakta: ETL/DQ-steg som finns "under huven"
' =========================================================
note over Region
**Detaljsteg som ingår i regionens körning (under huven)**
- ETL1: Hämta från källsystem till regionalt lager ("landning")
- DQ1: Grundkontroller (format, obligatoriska fält, kodverk)
- ETL2: Forma enligt gemensam struktur + beräkna väntetider (gemensamt räknesätt)
- DQ2: Rimlighetskontroller efter beräkning (datumordning, extrema värden)
- ETL3: Skapa leveranser/urval för olika användningsfall:
  A) Benchmark (sammanställning utan person-id)
  B) Socialstyrelsen väntetider (enligt deras mall)
  C) Socialstyrelsen patientdata (enligt deras mall)
  D) Övriga externa (enligt process/överenskommelse)
- DQ3: Slutkontroll före skick (kompletthet, summeringar, avvikelser)
end note

note over Hubb
**Detaljsteg som ingår i hubbens körning (under huven)**
- Tar emot, loggar och kvitterar (status + spårbarhet)
- Bearbetar/lagrar endast benchmark-underlag (utan person-id)
- Bygger jämförelser över tid + mellan regioner
- Vidareförmedlar leveranser till externa (fil nu / API sen)
end note

' =========================================================
' 1) Paketering och uppdatering (centralt -> region)
' =========================================================
== 1. Standardpaket (byggs och hålls uppdaterat centralt) ==

loop Vid uppdatering (ny version / nya krav / förbättrad logik)
  Hubb -> Region: Publicerar uppdaterat standardpaket (P1–P7)
  note over Hubb,Region
  Regionen slipper bygga om från grunden.
  Regionen uppgraderar version och kör samma flöde igen.
  end note
end

' =========================================================
' 2) Region skapar basunderlag (brett) + kvalitet + beräkningar
' =========================================================
== 2. Region skapar basunderlag (brett) och kör enligt standard ==

Region -> Region: Skapar **basunderlag** (brett) som kan användas för flera behov
Region -> Region: Gör automatiska kontroller (kvalitet + rimlighet)
Region -> Region: Räknar väntetider enligt gemensamt räknesätt (P3)
Region -> Region: Förbereder för snabb selektering ("index") för att minimera framtida överföringar

note over Region
**Nyckelidé:** Regionen tar fram ett bredare underlag en gång.
Sedan görs urval/mappning per användningsfall (se nästa steg).
end note

' =========================================================
' 3) Urval per användningsfall (tydliggör "många behov, samma bas")
' =========================================================
== 3. Urval per användningsfall (från samma basunderlag) ==

group Regionen gör urval/mappning per behov (utan att börja om från källorna)
  Region -> Region: Urval A – för jämförelse mellan regioner (sammanställning utan person-id)
  Region -> Region: Urval B – för Socialstyrelsen: väntetider (enligt deras mall)
  Region -> Region: Urval C – för Socialstyrelsen: patientdata (enligt deras mall)
  Region -> Region: Urval D – för annan extern användare (t.ex. forskning – enligt godkänd process)
end group

note over Region
Urvalen bygger på samma basunderlag.
Det gör att nya behov kan lösas genom nytt urval – inte nytt "specialuttag".
end note

' =========================================================
' 4) Två huvudspår: Benchmark/återkoppling + Distribution till externa
' =========================================================
== 4. Två spår (benchmark + extern distribution) ==

par Spår A: Benchmark & återkoppling (utan person-id)
  Region -> Hubb: Skickar Urval A (sammanställning utan person-id)
  Hubb -> Hubb: Bygger jämförelser över regioner & tid
  Hubb -> Region: Skickar tillbaka benchmark + förbättringsstöd + kvalitetsinsikter
else Spår B: Distribution till externa användare (via hubben)
  Region -> Hubb: Skickar Urval B/C/D för vidareförmedling
  note over Region,Hubb
  Regionen skickar en gång till hubben.
  Hubben sköter vidareförmedling + status/kvittenser.
  end note

  alt Pilotläge: Filöverföring
    Hubb -> Externa: Vidareförmedlar leverans (fil)
    Externa --> Hubb: Status/kvittenser (ok/fel)
  else Målbild: API
    Hubb -> Externa: Vidareförmedlar leverans (API)
    Externa --> Hubb: Status/kvittenser (ok/fel)
  end

  Hubb --> Region: Returnerar status/kvittenser + ev. felmeddelanden
end

' =========================================================
' 5) Federering via SPE (vid behov)
' =========================================================
== 5. Federerad beräkning via SPE (när centrala beräkningar kräver det) ==

alt När aggregerat räcker (ingen federering behövs)
  note over Hubb
  Hubb använder sammanställningar utan person-id
  för jämförelser och återkoppling.
  end note
else När beräkningen kräver koppling på individnivå men ska göras federerat
  critical Integritetskänsligt moment (federerat – data stannar regionalt)
    Hubb -> SPE: Startar federerad körning (välj fråga Q1/Q2/Q3 + period + regler)
    SPE -> Region: Federerad fråga (Q1/Q2/Q3) + urval (tidsperiod, regler)
    Region -> Region: Kör lokalt på basunderlaget (data stannar i regionen)
    Region --> SPE: Returnerar enbart sammanställda delresultat (ej individdata)
    SPE --> Hubb: Slår ihop delresultat och lämnar sammanställning
  end

  Hubb -> Region: Återkoppling (benchmark/insikter) baserat på federerat resultat
end

' =========================================================
' 6) Externa användare – exempel (förankrar att SoS ligger här)
' =========================================================
== 6. Externa användare (exempel) ==

note right of Externa
Exempel på externa användare:
- Socialstyrelsen (olika mottagningar)
- Forskning (via godkända processer)
- Andra nationella aktörer / jämförelsetjänster
end note

@enduml
