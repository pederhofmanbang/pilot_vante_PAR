@startuml
' =========================================================
' Regiongemensamt flöde (pilot + målbild) – Sekvensdiagram
' Deltagare: Region (vänster), Hubb (mitten), SPE (separat mitt), Externa användare (höger)
' Version: Med starkare färger för bättre visuell tydlighet
' =========================================================

title Regiongemensam hubb – flöde, federering och distribution (detaljnivå)

autonumber
hide footbox

skinparam shadowing false
skinparam backgroundColor #FFFFFF
skinparam sequence {
  ArrowColor #1E3A5F
  ArrowFontColor #1E3A5F
  LifeLineBorderColor #374151
  LifeLineBackgroundColor #FFFFFF
  ParticipantBorderColor #1F2937
  ParticipantBackgroundColor #FFFFFF
  ParticipantFontColor #1F2937
  ParticipantFontStyle bold
  BoxBorderColor #374151
  BoxBackgroundColor #F9FAFB
  GroupBackgroundColor #FEF3C7
  GroupBorderColor #D97706
  GroupFontColor #92400E
  NoteBackgroundColor #FEF9C3
  NoteBorderColor #CA8A04
  NoteFontColor #713F12
  DividerBackgroundColor #E0E7FF
  DividerBorderColor #4F46E5
  DividerFontColor #3730A3
}

' ---------------------------------------------------------
' Layout / swimlane-känsla (STARKARE FÄRGER)
' ---------------------------------------------------------
box "Region" #C7F9CC
participant Region as "Region\n(Producent + mottagare)" #A7F3D0
end box

box "Hubb (värd: t.ex. VGR)" #BFDBFE
participant Hubb as "Hubb\n(Standard + benchmark + transport)" #93C5FD
end box

box "SPE (kan drivas av region, myndighet eller annan aktör)" #DDD6FE
participant SPE as "SPE\n(Federerad beräkning vid behov)" #C4B5FD
end box

box "Externa användare" #FED7AA
participant SoS as "Socialstyrelsen\n(SoS)" #FDBA74
participant Extern as "Övriga externa\n(Forskning, andra aktörer)" #FB923C
end box

' =========================================================
' 0) Översikt/legend (synlig info istället för hover)
' =========================================================
note right of Hubb #E0F2FE
**Hubbens standardpaket (P1–P7), publiceras & versionshålls centralt**
P1. Gemensamma variabellistor (vad som behövs, definitioner)
P2. Gemensamma definitioner/struktur ("samma sak betyder samma sak")
P3. Gemensamt räknesätt för väntetider
P4. Gemensamma kvalitetskontroller (stoppar/varnar)
P5. Stöd för att koppla rätt (inkl. intelligent assistans)
P6. Mallar för leveranser till mottagare (t.ex. SoS väntetider & PAR)
P7. Spårbarhet (version, förändringar, "vad kördes när")
end note

note right of SPE #F3E8FF
**Vad SPE är (i det här upplägget)**
- Kör frågor "nära datat" (i regionerna)
- Hämtar inte hem individnivå i bulk
- Samlar bara sammanställda delresultat
- Används av hubb, regioner och externa (via policy-gate)
end note

note right of SoS #FFEDD5
**SoS:** Mottar väntetider & PAR (krypterat)
**Övriga externa:** Forskning, jämförelsetjänster
(kräver godkänd process/avtal)
end note

legend left
**Exempel på federerade frågor (Q1–Q3)**
Q1: Jämför väntetider per område & månad (median/percentiler)
Q2: Datakvalitet – andel saknade/ogiltiga fält senaste perioden
Q3: Andel som passerar gränsvärde (t.ex. > X dagar) per vecka

**Push vs Pull**
• **Push:** Region skickar leverans (krypterad för mottagare)
• **Pull:** Federerad fråga via SPE → sammanställda delresultat
endlegend

' =========================================================
' 0b) Fakta: ETL/DQ-steg som finns "under huven"
' =========================================================
note over Region #DCFCE7
**Detaljsteg som ingår i regionens körning (under huven)**
- ETL1: Hämta från källsystem till regionalt lager ("landning")
- DQ1: Grundkontroller (format, obligatoriska fält, kodverk)
- ETL2: Forma enligt gemensam struktur + beräkna väntetider (gemensamt räknesätt)
- DQ2: Rimlighetskontroller efter beräkning (datumordning, extrema värden)
- ETL3: Skapa leveranser/urval för olika användningsfall:
  A) Benchmark (sammanställning utan person-id)
  B) Socialstyrelsen väntetider (enligt deras mall)
  C) Socialstyrelsen patientdata (enligt deras mall)
  D) Övriga externa (enligt process/överenskommelse)
- DQ3: Slutkontroll före skick (kompletthet, summeringar, avvikelser)
end note

note over Hubb #DBEAFE
**Detaljsteg som ingår i hubbens körning (under huven)**
- Tar emot, loggar och kvitterar (status + spårbarhet)
- **Bearbetar/lagrar:** endast benchmark-underlag (utan person-id)
- Bygger jämförelser över tid + mellan regioner
- **Transporterar:** krypterade paket (blind relay), lagrar ej innehåll
end note

' =========================================================
' 1) Paketering och uppdatering (centralt -> region)
' =========================================================
== 1. Standardpaket (byggs och hålls uppdaterat centralt) ==

loop Vid uppdatering (ny version / nya krav / förbättrad logik)
  Hubb -> Region: Publicerar uppdaterat standardpaket (P1–P7)
  note over Hubb,Region #FEF3C7
  Regionen slipper bygga om från grunden.
  Regionen uppgraderar version och kör samma flöde igen.
  end note
end

' =========================================================
' 2) Region skapar basunderlag (brett) + kvalitet + beräkningar
' =========================================================
== 2. Region skapar basunderlag (brett) och kör enligt standard ==

Region -> Region: Skapar **basunderlag** (brett) som kan användas för flera behov
Region -> Region: Gör automatiska kontroller (kvalitet + rimlighet)
Region -> Region: Räknar väntetider enligt gemensamt räknesätt (P3)
Region -> Region: Förbereder för snabb selektering ("index") för att minimera framtida överföringar

note over Region #DCFCE7
**Nyckelidé:** Regionen tar fram ett bredare underlag en gång.
Sedan görs urval/mappning per användningsfall (se nästa steg).
end note

' =========================================================
' 3) Urval per användningsfall (tydliggör "många behov, samma bas")
' =========================================================
== 3. Urval per användningsfall (från samma basunderlag) ==

group Regionen gör urval/mappning per behov (utan att börja om från källorna)
  Region -> Region: Urval A – för jämförelse mellan regioner (sammanställning utan person-id)
  Region -> Region: Urval B – för Socialstyrelsen: väntetider (enligt deras mall)
  Region -> Region: Urval C – för Socialstyrelsen: patientdata (enligt deras mall)
  Region -> Region: Urval D – för annan extern användare (t.ex. forskning – enligt godkänd process)
end group

note over Region #DCFCE7
Urvalen bygger på samma basunderlag.
Det gör att nya behov kan lösas genom nytt urval – inte nytt "specialuttag".
end note

' =========================================================
' 4) Två huvudspår: Benchmark/återkoppling + Distribution till externa
' =========================================================
== 4. Två spår – PUSH (benchmark + extern distribution) ==

par Spår A: Benchmark & återkoppling (utan person-id)
  Region -> Hubb: Skickar Urval A (sammanställning utan person-id)
  Hubb -> Hubb: Bygger jämförelser över regioner & tid
  Hubb -> Region: Skickar tillbaka benchmark + förbättringsstöd + kvalitetsinsikter
else Spår B: Distribution till externa användare (via hubben, blind relay)
  Region -> Hubb: Skickar krypterat paket (för SoS/Extern) + manifest (checksummor, metadata, version)

  note over Region,Hubb #FEE2E2
  **Hubben kan inte dekryptera.**
  Den hanterar endast transport, spårbarhet, kvittens.
  end note

  alt Pilotläge: Filöverföring
    Hubb -> SoS: Vidarebefordrar krypterat paket (blind relay, fil)
    SoS --> Hubb: Status/kvittens (ok/fel)
    Hubb -> Extern: Vidarebefordrar krypterat paket (blind relay, fil)
    Extern --> Hubb: Status/kvittens (ok/fel)
  else Målbild: API
    Hubb -> SoS: Vidarebefordrar krypterat paket (blind relay, API)
    SoS --> Hubb: Status/kvittens (ok/fel)
    Hubb -> Extern: Vidarebefordrar krypterat paket (blind relay, API)
    Extern --> Hubb: Status/kvittens (ok/fel)
  end

  Hubb --> Region: Returnerar status/kvittenser + ev. felmeddelanden
end

' =========================================================
' 5) Federering via SPE (vid behov) – PULL
' =========================================================
== 5. Federerad beräkning via SPE – PULL (sammanställda resultat) ==

note over Hubb,Extern #E0E7FF
**Federering kan initieras av:**
• Region (för egen återkoppling/benchmark)
• Externa användare (för sammanställda svar, via policy-gate)
Rådata flyttas aldrig centralt – endast sammanställda delresultat.
end note

alt När aggregerat räcker (ingen federering behövs)
  note over Hubb #DBEAFE
  Hubb använder sammanställningar utan person-id
  för jämförelser och återkoppling.
  end note

else Alt A: Region/Hubb initierar federerad fråga
  critical Integritetskänsligt moment (federerat – data stannar regionalt)
    Hubb -> SPE: Startar federerad körning (välj fråga Q1/Q2/Q3 + period + regler)
    SPE -> Region: Federerad fråga (Q1/Q2/Q3) + urval (tidsperiod, regler)
    Region -> Region: Kör lokalt på basunderlaget (data stannar i regionen)
    Region --> SPE: Returnerar enbart sammanställda delresultat (ej individdata)
    SPE --> Hubb: Slår ihop delresultat och lämnar sammanställning
  end
  Hubb -> Region: Återkoppling (benchmark/insikter) baserat på federerat resultat

else Alt B: Extern användare initierar federerad fråga (via policy-gate)
  critical Extern begär federerad analys (godkänd process krävs)
    Extern -> Hubb: Begär federerad analys (Q1/Q2/Q3 + period + villkor)
    Hubb -> Hubb: Policy-gate (behörighet, ändamål, små-talsskydd, minsta möjliga data)
    Hubb -> SPE: Startar federerad körning (Qx + godkända parametrar)
    SPE -> Region: Federerad fråga (Qx) + urval (tidsperiod, regler)
    Region -> Region: Kör lokalt (data stannar i regionen)
    Region --> SPE: Delresultat (endast sammanställning, ej individdata)
    SPE --> Hubb: Sammanställt resultat
  end
  Hubb --> Extern: Levererar sammanställt resultat (aggregerat)

  note over Hubb,Extern #FEE2E2
  **Extern får endast sammanställt resultat enligt policy.**
  Ingen åtkomst till individdata eller rådata.
  end note
end

' =========================================================
' 6) Externa användare – sammanfattning
' =========================================================
== 6. Externa användare (sammanfattning) ==

note over SoS,Extern #FFEDD5
**Socialstyrelsen (SoS)**
• Mottar: Väntetider + PAR (krypterade leveranser via push)
• Kan begära: Federerade analyser (via pull/policy-gate)

**Övriga externa (forskning, jämförelsetjänster)**
• Mottar: Krypterade leveranser (om avtal finns)
• Kan begära: Federerade analyser (via pull/policy-gate)

**Gemensamt:** Hubben ser aldrig innehållet i krypterade leveranser.
end note

@enduml
