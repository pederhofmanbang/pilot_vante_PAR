# =========================================================
# Regiongemensam hubb ‚Äì fl√∂de, federering och distribution
# D2-version (arkitekturvy med fl√∂den)
# =========================================================

title: |md
  # Regiongemensam hubb
  ## Fl√∂de, federering och distribution
|

# ---------------------------------------------------------
# Styling
# ---------------------------------------------------------
direction: right

*.style.border-radius: 8
*.style.font-size: 14

# ---------------------------------------------------------
# Akt√∂rer/Komponenter
# ---------------------------------------------------------
region: Region {
  style: {
    fill: "#C7F9CC"
    stroke: "#16A34A"
    stroke-width: 2
  }

  label: |md
    **Region**
    *(Producent + mottagare)*
  |

  basunderlag: Basunderlag {
    style.fill: "#DCFCE7"
    label: |md
      üìä **Basunderlag**
      - ETL1: K√§llsystem ‚Üí lager
      - DQ1: Format, kodverk
      - ETL2: Struktur + v√§ntetider
      - DQ2: Rimlighet
    |
  }

  urval: Urval A/B/C/D {
    style.fill: "#BBF7D0"
    label: |md
      üìã **Urval per behov**
      A) Benchmark (PN-fritt)
      B) SoS v√§ntetider
      C) SoS patientdata
      D) √ñvrig extern
    |
  }

  basunderlag -> urval: ETL3 + DQ3
}

hubb: Hubb (VGR) {
  style: {
    fill: "#BFDBFE"
    stroke: "#2563EB"
    stroke-width: 2
  }

  label: |md
    **Hubb**
    *(Standard + benchmark + transport)*
  |

  standardpaket: Standardpaket P1-P7 {
    style.fill: "#DBEAFE"
    label: |md
      üì¶ **Standardpaket**
      P1. Variabellistor
      P2. Definitioner
      P3. R√§knes√§tt
      P4. Kvalitetskontroller
      P5. Kopplingsst√∂d
      P6. Leveransmallar
      P7. Sp√•rbarhet
    |
  }

  benchmark: Benchmark-motor {
    style.fill: "#93C5FD"
    label: |md
      üìà **Benchmark**
      J√§mf√∂relser √∂ver
      regioner & tid
    |
  }

  transport: Blind Relay Transport {
    style.fill: "#60A5FA"
    label: |md
      üîê **Blind Relay**
      Kan EJ dekryptera
      Endast transport +
      sp√•rbarhet + kvittens
    |
  }

  policy: Policy-gate {
    style.fill: "#3B82F6"
    style.font-color: white
    label: |md
      üõ°Ô∏è **Policy-gate**
      Beh√∂righet, √§ndam√•l
      Sm√•-talsskydd
    |
  }
}

spe: SPE {
  style: {
    fill: "#DDD6FE"
    stroke: "#7C3AED"
    stroke-width: 2
  }

  label: |md
    **SPE**
    *(Federerad ber√§kning)*

    üîí Data stannar regionalt
    Endast sammanst√§llda
    delresultat skickas
  |
}

externa: Externa anv√§ndare {
  style: {
    fill: "#FED7AA"
    stroke: "#EA580C"
    stroke-width: 2
  }

  sos: Socialstyrelsen {
    style.fill: "#FDBA74"
    label: |md
      üèõÔ∏è **SoS**
      ‚Ä¢ V√§ntetider
      ‚Ä¢ PAR
    |
  }

  ovriga: √ñvriga externa {
    style.fill: "#FB923C"
    label: |md
      üî¨ **√ñvriga**
      ‚Ä¢ Forskning
      ‚Ä¢ J√§mf√∂relsetj√§nster
    |
  }
}

# ---------------------------------------------------------
# Fl√∂den: PUSH (leveranser)
# ---------------------------------------------------------
push_label: {
  style: {
    fill: "#E0E7FF"
    stroke: "#4F46E5"
    stroke-width: 2
    border-radius: 12
  }
  label: |md
    ## üì§ PUSH-fl√∂den
    *Region skickar leverans*
  |
}

# Standardpaket till region
hubb.standardpaket -> region: {
  label: "1. Publicerar standardpaket"
  style.stroke: "#2563EB"
  style.stroke-width: 2
}

# Benchmark-fl√∂de
region.urval -> hubb.benchmark: {
  label: "2. Urval A (PN-fritt)"
  style.stroke: "#16A34A"
  style.stroke-width: 2
}

hubb.benchmark -> region: {
  label: "√Öterkoppling + insikter"
  style.stroke: "#16A34A"
  style.stroke-dash: 3
}

# Externa leveranser (blind relay)
region.urval -> hubb.transport: {
  label: "3. Krypterat paket B/C/D + manifest"
  style.stroke: "#EA580C"
  style.stroke-width: 2
}

hubb.transport -> externa.sos: {
  label: "Blind relay (fil/API)"
  style.stroke: "#EA580C"
  style.stroke-width: 2
}

hubb.transport -> externa.ovriga: {
  label: "Blind relay (fil/API)"
  style.stroke: "#EA580C"
  style.stroke-width: 2
}

externa.sos -> hubb.transport: {
  label: "Kvittens"
  style.stroke: "#EA580C"
  style.stroke-dash: 3
}

externa.ovriga -> hubb.transport: {
  label: "Kvittens"
  style.stroke: "#EA580C"
  style.stroke-dash: 3
}

# ---------------------------------------------------------
# Fl√∂den: PULL (federering)
# ---------------------------------------------------------
pull_label: {
  style: {
    fill: "#F3E8FF"
    stroke: "#7C3AED"
    stroke-width: 2
    border-radius: 12
  }
  label: |md
    ## üì• PULL-fl√∂den
    *Federerad fr√•ga via SPE*
  |
}

# Hubb initierar
hubb.policy -> spe: {
  label: "4a. Federerad fr√•ga (Q1/Q2/Q3)"
  style.stroke: "#7C3AED"
  style.stroke-width: 2
}

# Extern initierar
externa.ovriga -> hubb.policy: {
  label: "4b. Beg√§r analys"
  style.stroke: "#7C3AED"
  style.stroke-width: 2
}

externa.sos -> hubb.policy: {
  label: "4b. Beg√§r analys"
  style.stroke: "#7C3AED"
  style.stroke-dash: 3
}

# SPE till region
spe -> region.basunderlag: {
  label: "Fr√•ga + urval"
  style.stroke: "#7C3AED"
  style.stroke-width: 2
}

region.basunderlag -> spe: {
  label: "Sammanst√§llda delresultat"
  style.stroke: "#7C3AED"
  style.stroke-dash: 3
}

spe -> hubb.policy: {
  label: "Sammanst√§llt resultat"
  style.stroke: "#7C3AED"
  style.stroke-dash: 3
}

# ---------------------------------------------------------
# Viktig information
# ---------------------------------------------------------
info: {
  style: {
    fill: "#FEE2E2"
    stroke: "#DC2626"
    stroke-width: 2
    border-radius: 12
  }
  label: |md
    ## ‚ö†Ô∏è Viktigt

    **Hubben kan ALDRIG:**
    - Dekryptera externa leveranser
    - Se inneh√•llet i SoS/extern-data

    **Hubben lagrar ENDAST:**
    - Benchmark-data (PN-fritt)
    - Metadata & kvittenser

    **Federering:**
    - R√•data stannar i regionen
    - Endast aggregat skickas
  |
}
